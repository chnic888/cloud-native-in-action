# MicroK8s Cluster Automation

This directory contains the playbook and helper script used to install MicroK8s on the Multipass VMs defined in the repository root. After the VMs are provisioned (see `multipass/README.md`), the resources here turn them into a working MicroK8s cluster with one control-plane node and multiple workers.

## Components

- `build_micro8s_cluster.sh`: thin wrapper that executes the Ansible playbook with the inventory generated by the Multipass tooling.
- `install_micro8s.yaml`: the playbook that installs MicroK8s, enables core add-ons, and joins each worker to the cluster by requesting a fresh join token from `kvm00`.

## Prerequisites

1. The Multipass-based VMs already exist and are reachable via SSH (`inventory` file present in the repo root).
2. Ansible 2.13+ is installed on the control machine running the playbook.
3. Your user can run `sudo snap install` on each VM (handled automatically if the Multipass scripts were used).

## Usage

```bash
cd <repo-root>
./microk8s/build_micro8s_cluster.sh
```

What the playbook does:

1. Installs `snapd` (if necessary) and installs MicroK8s via snap on every VM.
2. Adds the `ubuntu` user to the `microk8s` group and sets up `~/.kube`.
3. Waits for MicroK8s to become ready on each host.
4. Enables the `dns`, `dashboard`, and `registry` add-ons on `kvm00`.
5. For every worker node, delegates `microk8s add-node --format short` to `kvm00` to obtain a unique join command, then executes that command locally with `--worker`.

## Verification

After the playbook completes, open a shell on `kvm00` and run:

```bash
microk8s status --wait-ready
microk8s kubectl get nodes
```

You should see all nodes in `Ready` state. Use `microk8s kubectl get pods -A` to confirm system pods are healthy.

## Troubleshooting

- **Join failures**: rerun the playbook; each worker requests a token dynamically, so transient errors are resolved automatically.
- **microk8s status hangs**: check VM resources (CPU/RAM) and ensure the Multipass instances have at least 2 vCPU and 4 GB RAM as configured by the provisioning scripts.
- **Add-on enable errors**: run `microk8s status --wait-ready` on `kvm00` to confirm the control-plane is healthy, then manually re-run `microk8s enable dns dashboard registry`.
